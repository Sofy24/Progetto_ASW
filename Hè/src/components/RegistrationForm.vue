<script setup lang="ts">
import { ref, onMounted, computed } from 'vue'
import axios from 'axios'

const name = ref('')
const surname = ref('')
const email = ref('')
const municipality = ref('')
const password = ref('')
const municipalities = ref([] as string[])
const searchQuery = ref('')

onMounted(() => {
  fetchMunicipalityNames()
});

const filteredOptions = computed(() => {
  const query = searchQuery.value.toLowerCase()
  return municipalities.value.filter((option) =>
    option.toLowerCase().includes(query)
  );
});

const isPasswordValid = computed(() => {
  const passwordRegex = new RegExp(/^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$ %^&*-]).{8,}$/)
  return passwordRegex.test(password.value)
});

const submitForm = () => {
  const formData = {
    name: name.value,
    surname: surname.value,
    email: email.value,
    municipality: municipality.value,
    password: password.value,
  };

  console.log(formData)

  axios.post('http://localhost:3000/user/register', formData)
    .then((response) => {
      console.log('Form data sent and stored successfully:', response.data)
    })
    .catch((error) => {
      console.error('Error sending form data:', error)
    });
};

const fetchMunicipalityNames = () => {
  axios.get('http://localhost:3000/municipality/names')
    .then((response) => {
      municipalities.value = response.data;
    })
    .catch((error) => {
      console.error('Error retrieving municipalities names:', error)
    })
};
</script>

<template>
  <form @submit.prevent="submitForm">
    <div>
      <label for="name">Nome:</label>
      <input type="text" id="name" v-model="name" required>
    </div>
    <div>
      <label for="surname">Cognome:</label>
      <input type="text" id="surname" v-model="surname" required>
    </div>
    <div>
      <label for="email">Email:</label>
      <input type="email" id="email" v-model="email" required pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$">
    </div>
    <div>
      <label for="password">Password:</label>
      <input type="password" id="password" v-model="password" required>
      <span v-if="!isPasswordValid" class="password-requirements">
          La password deve avere almeno 8 caratteri di cui almeno una maiuscola, una minuscola, un numero e un simbolo.
      </span>
    </div>
    <div>
      <label for="municipality">Comune di Residenza:</label>
      <select id="municipality" v-model="municipality" required>
          <option value="">Seleziona il tuo Comune</option>
          <option v-for="option in filteredOptions" :value="option" :key="option">
            {{ option}}
          </option>
        </select>
      </div>
    <button type="submit">Registrati</button>
  </form>
</template>

<style>
  .password-requirements {
    color: red;
    font-size: 0.8em;
  }
</style>